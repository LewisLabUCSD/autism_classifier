---
title: "ClassificationPaper_final"
author: "Gazestani, Bokan Edited"
date: "1/23/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
.mySampleScoreArrangerFn=function(inputPath){
  #This function reads in the sample scores (between 0 and 1)
  # inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/main_runner_new//"

  resCombined=list()
  tmpFiles=list.files(inputPath)
  tmpFiles=intersect(tmpFiles,paste0("out",1:25))
  if((length(tmpFiles))!=25){
    print(paste("caution: number of files is",(length(tmpFiles))))
  }
  
  
  for(i in 1:(length(tmpFiles))){
    load(paste0(inputPath,tmpFiles[i],"/results.rda"))
    
    tmp=result$ROCdf
    
    resdf=list()
    for(j in 1:length(tmp)){
      #print(j)
      tmpdf=tmp[[j]][[1]]
      tmpdf$status=tmp[[j]][[2]]
      colnames(tmpdf)=c("sampleName","real","estimated","status")
      resdf=c(resdf,list(tmpdf))
    }
    resdf=do.call("rbind",resdf)
    resdf=resdf[!duplicated(paste0(resdf$sampleName,"_",resdf$status)),]
    resCombined=c(resCombined,list(resdf))
  }
  
  return(resCombined)
}
.myClassificationEvaluationFn=function(testLabelsHat,testLabels){
  require(PRROC,quietly=T)
  require(pROC,quietly=T)
  
  finalResPR=pr.curve(scores.class0=testLabelsHat,weights.class0=testLabels)$auc.integral
  finalResROC=as.numeric(roc(response=testLabels,predictor=as.vector(testLabelsHat))$auc)
  
  return(list(ROC=finalResROC,PR=finalResPR,ROCdata=roc(response=testLabels,predictor=as.vector(testLabelsHat)),PRdata=pr.curve(scores.class0=testLabelsHat,weights.class0=testLabels)))
}
.myResultOrganizerFn=function(inputPath,countThr=NULL,replaceZero=F){
  #results with number of folds less than the countThr are set to zero
  #zeros can be replaced with 0.5 (ROC and PR)
  load(inputPath)
  inputData=ROCres
  
  if(is.null(countThr)){
    countThr=max(inputData[[2]])
  }
  
  inputData[[1]][inputData[[2]]<countThr]=0
  if(replaceZero){
    inputData[[1]][inputData[[1]]==0]=0.5
  }
  res=inputData[[1]]
  
  thr=0
  if(replaceZero){
    thr=0.5
  }
  x=apply(res,1,function(x) sum(x==thr))
  res=res[which(x<(ncol(inputData[[1]])-1)),]
  return(res)
}
library(ggplot2)
library(reshape2)
library(limma)
library(gplots)

.myDataArrangerFn=function(inputPath,inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"),wCompleteDS=F){
  #data$average: simple average of sample scores across folds for the same subject with the same features+classifier
  #data$concensus: concensus scores of models with ROCthr >inputROCthr
  # inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/final_classificationSet_main/"
  # inputROCthr=0.7
  # inputROCPower=2
  # colorset=c("black","red")
  # wCompleteDS=F
  # inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_longitudinal/"
  # inputROCthr=0.7
  # inputROCPower=2
  # colorset=c("black","red")
  # load(paste0(inputPath,"ResultsArranged.rda"))
  weightsROC=.myResultOrganizerFn(paste0(inputPath,"ResultsArranged.rda"),replaceZero = T)
  load(paste0(inputPath,"ResultsArranged.rda"))
  PRs=PRres[[1]]
  PRs=PRs[row.names(PRs) %in% row.names(weightsROC),]
  PRs_counts=PRres[[2]]
  PRs_counts=PRs_counts[row.names(PRs_counts) %in% row.names(weightsROC),]
  PRs=PRs[,-which(colnames(PRs)=="sqda")]
  PRs_counts=PRs_counts[,-which(colnames(PRs_counts)=="sqda")]
  
  ROCs=ROCres[[1]]
  ROCs=ROCs[row.names(ROCs) %in% row.names(weightsROC),]
  ROCs_counts=ROCres[[2]]
  ROCs_counts=ROCs_counts[row.names(ROCs_counts) %in% row.names(weightsROC),]
  ROCs=ROCs[,-which(colnames(ROCs)=="sqda")]
  ROCs_counts=ROCs_counts[,-which(colnames(ROCs_counts)=="sqda")]
  
  countThr=max(ROCs_counts)
  slInd=as.data.frame(which(ROCs_counts<countThr,arr.ind = T))
  slInd=unique(slInd$row)
  weightsROC=weightsROC[-which(row.names(weightsROC) %in% row.names(ROCs_counts)[slInd]),]
  ROCs=ROCs[-which(row.names(ROCs) %in% row.names(ROCs_counts)[slInd]),]
  PRs=PRs[-which(row.names(PRs) %in% row.names(ROCs_counts)[slInd]),]
  PRs_counts=PRs_counts[-which(row.names(PRs_counts) %in% row.names(ROCs_counts)[slInd]),]
  ROCs_counts=ROCs_counts[-which(row.names(ROCs_counts) %in% row.names(ROCs_counts)[slInd]),]
  if(sum(colnames(weightsROC)=="sqda")>0){
    weightsROC=weightsROC[,-which(colnames(weightsROC)=="sqda")]
  }
  
  print("Number of models:")
  print(dim(weightsROC))
  
  print("max scores per classifier:")
  print(apply(weightsROC,2,max))
  pdf(file=paste0(inputPath,"boxplot.pdf"))
  boxplot(weightsROC,legend = F)
  dev.off()
  data=.mySampleScoreArrangerFn(inputPath)



  data=do.call("rbind",data)
  
  #removing the fold information from feature selection routes to allow the integration of results across folds
  status=gsub("^independent","^independent_1",data$status)
  status=strsplit(status,"_")
  status=unlist(lapply(status,function(x)paste(x[3:length(x)],collapse = "_")))
  data$statusUpdated=status #statusUpdated: feature selection route without info on the fold
  rm(status)
  
  #weighting the scores based on the model's ROC
  x=as.data.frame(weightsROC)
  x$id=row.names(x)
  x=reshape2::melt(x,by="id")
  
  x2=strsplit(x$id,"_")
  x2=unlist(lapply(x2,function(x)paste(x[2:length(x)],collapse = "_")))
  x2=paste0(x2,"_",as.character(x$variable))
  x2=gsub("independent","real",x2)
  x$status=x2
  
  data=data[data$statusUpdated %in% x$status,]
  x=x[x$status %in% data$statusUpdated,]
  
  x=x[,c("status","value")]
  colnames(x)[2]="weightROC"
  data=merge(data,x,by.x='statusUpdated',by.y="status")
  rm(x)
  #tmp=as.data.frame(table(data$status[data$estimated>1]))
  #tmp=strsplit(as.character(tmp$Var1),"_")
  #tmp=unlist(lapply(tmp,function(x) x[length(x)]))
  
  data=data[which(data$estimated>=0 & data$estimated<=1),]
  data$id=paste0(data$statusUpdated,"_",data$sampleName)
  data=list(data=data)
  data$average=aggregate(estimated~id,data=data$data,FUN=mean)
  
  data3=data$data[,c("id","sampleName","real","statusUpdated","weightROC")]
  data3=data3[!duplicated(data3$id),]
  data3=merge(data$average,data3,by="id")
  
  data$average=data3
  rm(data3)
  
  #ref_data=melt(dataMain$data$weightsROC)
  #ref_data$status=paste0(ref_data[,1],"_",ref_data[,2])
  #ref_data=ref_data[,c(4,3)]
  #colnames(ref_data)=c("statusUpdated","ref_weightROC")
  #ref_data=ref_data[ref_data$ref_weightROC>median(ref_data$ref_weightROC),]
  #ref_data$statusUpdated=gsub("real_","",as.character(ref_data$statusUpdated))
  #tmp=merge(data$average,ref_data,by="statusUpdated")
  #tmp=tmp[!duplicated(tmp$statusUpdated),]
  
  data$average$modWeightROC=data$average$weightROC-0.7
  data$average$modWeightROC[which(data$average$modWeightROC<0)]=0
  data$average$weightedEstimate=data$average$estimated*(data$average$modWeightROC)^inputROCPower
  
  
  data3=data$average
  data3$dx=paste0(data3$statusUpdated,"_dx",data3$real)
  tmp=data3[,c("dx","real")]
  tmp=tmp[!duplicated(tmp$dx),]
  data3med=aggregate(weightedEstimate~dx,data=data3,median)
  data$overallSubjectMean=merge(data3med,tmp,by="dx")
  rm(tmp,data3med,data3)
  status=data$overallSubjectMean$dx
  status=strsplit(status,"_")
  status=unlist(lapply(status,function(x) paste(x[1:(length(x)-1)],collapse = "_")))
  data$overallSubjectMean$status=status
  rm(status)
  
  tmp=dcast(data = data$average,formula = statusUpdated~sampleName,fun.aggregate = sum,value.var = "weightedEstimate")


  df=data.frame(sampleName=colnames(tmp),isSel=1,stringsAsFactors = F)
  df=df[!duplicated(df$sampleName),]
  df=merge(df,data.frame(sampleName=data$average$sampleName,real=data$average$real,stringsAsFactors = F),by="sampleName")
  df=df[!duplicated(df$sampleName),]
  df=df[match(colnames(tmp)[-1],df$sampleName),]
  labelsVector=df$real
  labcol=rep("black",length(labelsVector))
  
  
  colramp = colorRampPalette(c("orange","yellow","black","purple","purple"))(15)
  scale="none"
  main=""
  
  xx=as.matrix(dist(t(tmp[,-1])))
  xxx=cor(xx)
  labcol[labelsVector==0]=colorset[1]
  labcol[labelsVector==1]=colorset[2]
  pdf(file=paste0(inputPath,"heatmap.pdf"))
  hm=heatmap.2(as.matrix(dist(t(tmp[,-1]))),col=colramp,RowSideColors = labcol,hclustfun=function(d) stats::hclust(d, method="ward.D2"),distfun=function(x) as.dist(1-cor(t(x))), ColSideColors = labcol, margins = c(5,10),scale=scale,main=main,trace="none",density.info=c("none")) 
  #eval(hm$call)
  dev.off()
  tmp2=data$average[,c("sampleName","real")]
  tmp2=tmp2[!duplicated(tmp2$sampleName),]
  data$concensus=apply(tmp[,-1],2,sum)
  data$concensus=data.frame(sampleName=names(data$concensus),weightedEstimate=data$concensus,stringsAsFactors = F)
  data$concensus=merge(data$concensus,tmp2,by="sampleName")

  data$concensus$weightedEstimate=data$concensus$weightedEstimate - min(data$concensus$weightedEstimate)
  data$concensus$weightedEstimate=data$concensus$weightedEstimate/max(data$concensus$weightedEstimate)
  
  print(table(data$concensus$real,data$concensus$weightedEstimate>quantile(data$concensus$weightedEstimate,0.9)))
  print(table(data$concensus$real,data$concensus$weightedEstimate>quantile(data$concensus$weightedEstimate,0.8)))
  print(table(data$concensus$real,data$concensus$weightedEstimate>quantile(data$concensus$weightedEstimate,0.75)))
  print(table(data$concensus$real,data$concensus$weightedEstimate>quantile(data$concensus$weightedEstimate,0.7)))
  print(.myClassificationEvaluationFn(data$concensus$weightedEstimate,data$concensus$real))

  data$weightsROC=weightsROC
  
#   dataSubjectId=data$concensus
#   if(wCompleteDS){
#     load("~/Documents/archive/dropbox_shared_tiziano/WG6/WG6_HT12_Complete.rda")
#   } else {
#     load("~/Documents/archive/dropbox_shared_tiziano/WG6/WG6_HT12_missingSomeSamples.rda")
#   }
#   
# dataSubjectId=merge(dataSubjectId,data.frame(subjectId=dataQuantile$subjectId,sampleName=colnames(dataQuantile),age=dataQuantile$age,diagnosis_binary=dataQuantile$diagnosis_binary),by='sampleName')
#   
# load("~/Documents/archive/UCSD_data/myData/LWdata.rda")
# LWdata$final_ADOS_CoSoTot[LWdata$DxJ_Count==1]=LWdata$ados_CoSoTot_1[LWdata$DxJ_Count==1]
# LWdata$final_ADOS_CoSoRRTot[LWdata$DxJ_Count==1]=LWdata$ados_CoSoTotRRTot_1[LWdata$DxJ_Count==1]
# 
# LWdata$final_ADOS_CoSoTot[is.na(LWdata$final_ADOS_CoSoTot)]=LWdata$ados_CoSoTot_1[is.na(LWdata$final_ADOS_CoSoTot)]
# 
# LWdata$final_ADOS_CoSoRRTot[is.na(LWdata$final_ADOS_CoSoRRTot)]=LWdata$ados_CoSoTotRRTot_1[is.na(LWdata$final_ADOS_CoSoRRTot)]
# 
# LWdata$final_mullen_ELC[is.na(LWdata$final_mullen_ELC)]=LWdata$mullen_ELC_Std_1[is.na(LWdata$final_mullen_ELC)]
# 
# LWdata$final_mullen_ELT[is.na(LWdata$final_mullen_ELT)]=LWdata$mullen_ELT_1[is.na(LWdata$final_mullen_ELT)]
# 
# LWdata$final_mullen_RLT[is.na(LWdata$final_mullen_RLT)]=LWdata$mullen_RLT_1[is.na(LWdata$final_mullen_RLT)]
# 
# LWdata$final_mullen_FMT[is.na(LWdata$final_mullen_FMT)]=LWdata$mullen_FMT_1[is.na(LWdata$final_mullen_FMT)]
# 
# LWdata$final_mullen_VRT[is.na(LWdata$final_mullen_VRT)]=LWdata$mullen_VRT_1[is.na(LWdata$final_mullen_VRT)]
# 
# LWdata$final_vine_AdapBehav_DomStd[is.na(LWdata$final_vine_AdapBehav_DomStd)]=LWdata$vine_AdapBehav_DomStd_1[is.na(LWdata$final_vine_AdapBehav_DomStd)]
# 
# dataSubjectId=merge(dataSubjectId,LWdata,by.x = "subjectId",by.y='subjectid')
# 
# if(nrow(data$concensus)!=nrow(dataSubjectId)){
#   print("error")
# }

# data$concensus=dataSubjectId
data$PR_values=PRs


xROC=as.data.frame(which(ROCs>0.8,arr.ind = T))
xPR=as.data.frame(which(PRs>0.8,arr.ind = T))

xROC=paste0(row.names(ROCs)[xROC$row],"-",colnames(ROCs)[xROC$col])
xPR=paste0(row.names(PRs)[xPR$row],"-",colnames(PRs)[xPR$col])

  return(list(data=data,heatmap=hm))
  
}

.myROCDensityDataFn=function(){
  xMain=data.frame(id=row.names(dataMain$data$weightsROC),dataMain$data$weightsROC,stringsAsFactors = F)
xMain=melt(xMain,id.vars = "id")
xMain$datasetName="Main"

xLong=data.frame(id=row.names(dataLong$data$weightsROC),dataLong$data$weightsROC,stringsAsFactors = F)
xLong=melt(xLong,id.vars = "id")
xLong$datasetName="Longitudinal"

xTest=data.frame(id=row.names(dataTest$data$weightsROC),dataTest$data$weightsROC,stringsAsFactors = F)
xTest=melt(xTest,id.vars = "id")
xTest$datasetName="Test"

xLD=data.frame(id=row.names(dataLD$data$weightsROC),dataLD$data$weightsROC,stringsAsFactors = F)
xLD=melt(xLD,id.vars = "id")
xLD$datasetName="LD"
ROCscombined=rbind(xMain,xTest,xLong,xLD)
return(ROCscombined)
}

.myAlternativeModelExplorerFn=function(inputData){
  # inputData=dataMain
  indxPoor=inputData$data$concensus$sampleName[inputData$data$concensus$weightedEstimate<0.75&inputData$data$concensus$real==1]
indxPoor=inputData$data$average[inputData$data$average$sampleName %in% indxPoor,]

indxTD=inputData$data$concensus$sampleName[inputData$data$concensus$weightedEstimate>0.65&inputData$data$concensus$real==0]
indxTD=inputData$data$average[inputData$data$average$sampleName %in% indxTD,]
return(list(indxASDPoor=indxPoor,indxTDPoor=indxTD))
}

```

```{r echo=F,eval=F}
#removed parts

#dataMain=.myDataArrangerFn(inputPath="~/OneDrive - UC San Diego/Vahid/OneDrive - UC San Diego/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes_wF_v2/mainDataset_HT12/classificationSet_subject_scores/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"),wCompleteDS=T)

#dataTest=.myDataArrangerFn(inputPath="~/OneDrive - UC San Diego/Vahid/OneDrive - UC San Diego/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes_wF_v2/validation/testDataset_HT12/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"),wCompleteDS=T)

#dataMain=.myDataArrangerFn(inputPath="~/OneDrive - UC San Diego/Vahid/OneDrive - UC San Diego/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/mainDataset_HT12_WG6_deconv_genes/classificationSet_subject_scores/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"))

#dataLong=.myDataArrangerFn(inputPath="~/OneDrive - UC San Diego/Vahid/OneDrive - UC San Diego/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/validation/Longitudinaltest/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"),wCompleteDS=F)

#dataLD=.myDataArrangerFn(inputPath="~/OneDrive - UC San Diego/Vahid/OneDrive - UC San Diego/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/validation/LDtestDataset_HT12/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","green"),wCompleteDS=F)
```


```{r eval=F}
rm(list=ls())

# Change all to the currently working directory
# dataMain=.myDataArrangerFn(inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/main_runner_new/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"))
# .myDataCollector("/Volumes/Work/Vahid_work/classification_newcode_data/final_classificationSet_main/")

dataMain=.myDataArrangerFn(inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/final_classificationSet_main/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"))

# .myDataCollector("/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_test/")
dataTest=.myDataArrangerFn(inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_test/",inputROCthr=0.8,inputROCPower=2,colorset=c("black","red"))

# .myDataCollector("/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_longitudinal/")
dataLong=.myDataArrangerFn(inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_longitudinal/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","red"))#,wCompleteDS=T)

# .myDataCollector("/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_LD/")

dataLD=.myDataArrangerFn(inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_LD/",inputROCthr=0.7,inputROCPower=2,colorset=c("black","green"))#,wCompleteDS=T)

#save(dataLD,dataMain,dataLong,dataTest,file="~/Desktop/myData/classification_age_balanced05162019_wF_v2.rda")

save(dataLD,dataMain,dataLong,dataTest,file="/Volumes/Work/Vahid_work/classification_newcode_data/final_result_all.rda")

rm(list=ls())
load("~/Documents/archive/papers/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/perm1/ResultsArranged.rda")
perm1=ROCres
rm(perc85,perc9,perc95,PRres,res9,res85,res95,ROCres)
load("~/Documents/archive/papers/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/perm2/ResultsArranged.rda")
perm2=ROCres
rm(perc85,perc9,perc95,PRres,res9,res85,res95,ROCres)
load("~/Documents/archive/papers/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/perm3/ResultsArranged.rda")
perm3=ROCres
rm(perc85,perc9,perc95,PRres,res9,res85,res95,ROCres)
load("~/Documents/archive/papers/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/perm4/ResultsArranged.rda")
perm4=ROCres
rm(perc85,perc9,perc95,PRres,res9,res85,res95,ROCres)
load("~/Documents/archive/papers/classificationPaper/HT_as_test_05142019/ageBalanced_decov_genes/perm5/ResultsArranged.rda")
perm5=ROCres
rm(perc85,perc9,perc95,PRres,res9,res85,res95,ROCres)

perm1[[1]][which(perm1[[2]]<5)]=0.5
perm2[[1]][which(perm2[[2]]<5)]=0.5
perm3[[1]][which(perm3[[2]]<5)]=0.5
perm4[[1]][which(perm4[[2]]<5)]=0.5
perm5[[1]][which(perm5[[2]]<5)]=0.5

perm1=perm1[[1]]
perm2=perm2[[1]]
perm3=perm3[[1]]
perm4=perm4[[1]]
perm5=perm5[[1]]

all(perm1==perm2)

sum(perm1>0.8)+sum(perm2>0.8)+sum(perm3>0.8)+sum(perm4>0.8)+sum(perm5>0.8)

```


```{r}
rm(list=ls())
load("/Volumes/Work/Vahid_work/classification_newcode_data/final_result_all.rda")

# write.table(dataMain[["data"]][["weightsROC"]],file="/Volumes/Work/Vahid_work/classification_newcode_data/final_classificationSet_main/roc_mean1.csv",sep = ",")


#Long dataset
#Fraction of high performing paths that are in common between the main and test datasets
row.names(dataLong$data$weightsROC)=gsub("independent","real",row.names(dataLong$data$weightsROC))

x=dataLong$data$weightsROC
x=x[row.names(x) %in% row.names(dataMain$data$weightsROC),]

x2=as.data.frame(which(dataMain$data$weightsROC>0.8,arr.ind = T))

counter=0
x2=x2[row.names(dataMain$data$weightsROC)[x2$row] %in% row.names(dataLong$data$weightsROC),]
for(i in 1:nrow(x2)){
  if(x[row.names(dataMain$data$weightsROC)[x2$row[i]],colnames(dataMain$data$weightsROC)[x2$col[i]]]>0.8){
    counter=counter+1
  }
  
}
x2=as.data.frame(which(dataMain$data$weightsROC>0.8,arr.ind = T))

counter/nrow(x2)
counter
#Test dataset
#Fraction of high performing paths that are in common between the main and test datasets
row.names(dataTest$data$weightsROC)=gsub("independent","real",row.names(dataTest$data$weightsROC))

x=dataTest$data$weightsROC
x=x[row.names(x) %in% row.names(dataMain$data$weightsROC),]

x2=as.data.frame(which(dataMain$data$weightsROC>0.8,arr.ind = T))

counter=0
slFeatures=c()
x2=x2[row.names(dataMain$data$weightsROC)[x2$row] %in% row.names(dataTest$data$weightsROC),]
for(i in 1:nrow(x2)){
  if(x[row.names(dataMain$data$weightsROC)[x2$row[i]],colnames(dataMain$data$weightsROC)[x2$col[i]]]>=0.75){
    counter=counter+1
    slFeatures=c(slFeatures,row.names(dataMain$data$weightsROC)[x2$row[i]])
  }
}
x2=as.data.frame(which(dataMain$data$weightsROC>0.8,arr.ind = T))

counter/nrow(x2)
counter
#LD dataset
#Fraction of high performing paths that are in common between the main and LD datasets
row.names(dataLD$data$weightsROC)=gsub("independent","real",row.names(dataLD$data$weightsROC))

x=dataLD$data$weightsROC
x=x[row.names(x) %in% row.names(dataMain$data$weightsROC),]

x2=as.data.frame(which(dataMain$data$weightsROC>0.8,arr.ind = T))

counter=0
slFeatures=c()
x2=x2[row.names(dataMain$data$weightsROC)[x2$row] %in% row.names(dataLD$data$weightsROC),]
for(i in 1:nrow(x2)){
  if(x[row.names(dataMain$data$weightsROC)[x2$row[i]],colnames(dataMain$data$weightsROC)[x2$col[i]]]>=0.75){
    counter=counter+1
    slFeatures=c(slFeatures,row.names(dataMain$data$weightsROC)[x2$row[i]])
  }
}
x2=as.data.frame(which(dataMain$data$weightsROC>0.8,arr.ind = T))

counter/nrow(x2)


#density plots of model ROCs
ROCscombined=.myROCDensityDataFn()

ROCperm[[1]][ROCperm[[2]]<5]=0.5
ROCperm=ROCperm[[1]]
ROCperm=ROCperm[,-which(colnames(ROCperm)=="sqda")]
ROCperm=data.frame(id=row.names(ROCperm),ROCperm,stringsAsFactors = F)
ROCperm=melt(ROCperm,by="id")
ROCperm$datasetName="perm"
ROCperm$variable=as.character(ROCperm$variable)
ROCscombined$variable=as.character(ROCscombined$variable)
ROCscombined=rbind(ROCscombined,ROCperm)
ggplot(ROCscombined,aes(color=datasetName,fill=datasetName,value))+geom_density(size=1)+scale_color_manual(values=c("green","orange","red",NA,"pink"))+scale_fill_manual(values=c(NA,NA,NA,"gray",NA))+theme_bw()+theme(panel.grid = element_blank(),axis.text = element_text(color = "black"))+geom_vline(xintercept = 0.5,color="purple")+xlab("AUC-ROC")


pdf(file=paste0(inputPath,"main_boxplot.pdf"))

ggplot(dataMain$data$concensus,aes(factor(real),weightedEstimate))+geom_boxplot(outlier.shape = NA)+theme_bw()+geom_jitter(aes(fill=factor(real)),width = 0.4,shape=21)+ggtitle("Evaluation data")+theme(legend.position = "none",axis.text = element_text(color="black"))+xlab("DX")+ylab("Sample score")
dev.off()

pdf(file=paste0(inputPath,"test_boxplot.pdf"))
ggplot(dataTest$data$concensus,aes(factor(real),weightedEstimate))+geom_boxplot(outlier.shape = NA)+theme_bw()+geom_jitter(aes(fill=factor(real)),width = 0.4,shape=21)+ggtitle("Test data")+theme(legend.position = "none",axis.text = element_text(color="black"))+xlab("DX")+ylab("Sample score")
dev.off()

pdf(file=paste0(inputPath,"main_test_boxplot.pdf"))
new_table=dataMain$data$concensus
nrow(new_table)
new_table=rbind(dataMain$data$concensus, dataTest$data$concensus)
plate=c(rep('main', 175), rep('test',65))
new_table$plate = plate
ggplot(new_table,aes(x = factor(real), y=weightedEstimate, fill=factor(plate)))+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  # geom_jitter(width = 0.2, alpha=0.6, shape=21)+
  geom_point(position=position_jitterdodge(dodge.width=0.7), shape=21)+
  ggtitle("Evaluation data")+theme(legend.position = "none", axis.text = element_text(color="black"))+xlab("DX")+ylab("Sample score")
dev.off()

pdf(file=paste0(inputPath,"long_boxplot.pdf"))
ggplot(dataLong$data$concensus,aes(factor(real),weightedEstimate))+geom_boxplot(outlier.shape = NA)+theme_bw()+geom_jitter(aes(fill=factor(real)),width = 0.4,shape=21)+ggtitle("Longitudinal data")+theme(legend.position = "none",axis.text = element_text(color="black"))+xlab("DX")+ylab("Sample score")
dev.off()

pdf(file=paste0(inputPath,"LD_boxplot.pdf"))
ggplot(dataLD$data$concensus,aes(factor(real),weightedEstimate))+geom_boxplot(outlier.shape = NA)+theme_bw()+geom_jitter(aes(fill=factor(real)),width = 0.4,shape=21)+ggtitle("LD data")+theme(legend.position = "none",axis.text = element_text(color="black"))+xlab("DX")+ylab("Sample score")
dev.off()


#AU-ROC of the composite scores
inputPath="/Volumes/Work/Vahid_work/classification_newcode_data/final_result_plot/"
pdf(file=paste0(inputPath,"roc_curve.pdf"))
Mainvis=.myClassificationEvaluationFn(dataMain$data$concensus$weightedEstimate,dataMain$data$concensus$real)
plot(Mainvis$ROCdata,xlim=c(1,0),ylim=c(0,1),main="ROC curve",col='black')
# dev.off()
# pdf(file=paste0(inputPath,"test_roc.pdf"))
Testvis=.myClassificationEvaluationFn(dataTest$data$concensus$weightedEstimate,dataTest$data$concensus$real)
lines(Testvis$ROCdata,xlim=c(1,0),ylim=c(0,1),col="red")
legend(0.3, 0.3, legend=c("Main", "Test"),
       col=c("black", "red"), lty=c(1,1), cex=1.2)
dev.off()

#correlation with clinical characteristics
# load("/Volumes/Work/Vahid_work/classification_newcode_data/inputDataJabba_main.rda")
# write.table(inputExpData@phenoData@data, file="/Volumes/Work/Vahid_work/classification_newcode_data/final_result_plot/main_pheno.csv",sep = ",")
main_pheno_up <- read.csv("/Volumes/Work/Vahid_work/classification_newcode_data/final_result_plot/main_pheno_up.csv", row.names=1)
dataMain$data$concensus$final_ADOS_CoSoTot = main_pheno_up[dataMain$data$concensus$sampleName, 'final_ADOS_CoSoTot']
dataMain$data$concensus$recentDxJ_dxCode = main_pheno_up[dataMain$data$concensus$sampleName, 'recentDxJ_dxCode']
dataMain$data$concensus$recentDxJ_ageMo = main_pheno_up[dataMain$data$concensus$sampleName, 'recentDxJ_ageMo']

cor(dataMain$data$concensus$weightedEstimate, dataMain$data$concensus$final_ADOS_CoSoTot,use="complete.obs")
ggplot(dataMain$data$concensus[dataMain$data$concensus$recentDxJ_dxCode %in% c("ASD","ASD Features"),],aes(as.numeric(final_ADOS_CoSoTot),weightedEstimate,color=recentDxJ_dxCode))+geom_point()+geom_smooth(method = "lm")+ggtitle("Eval dataset")



load("/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_test/out1/data.rda")
write.table(data[["testInputData"]]@phenoData@data, file="/Volumes/Work/Vahid_work/classification_newcode_data/final_result_plot/test_pheno.csv",sep = ",")
ggplot(dataTest$data$concensus[dataTest$data$concensus$recentDxJ_dxCode %in% c("ASD","ASD Features"),],aes(as.numeric(final_ADOS_CoSoTot),weightedEstimate,color=recentDxJ_dxCode))+geom_point()+geom_smooth(method = "lm")+ggtitle("Test dataset")

test_pheno_up <- read.csv("/Volumes/Work/Vahid_work/classification_newcode_data/final_result_plot/test_pheno_up.csv", row.names=1)
dataTest$data$concensus$final_ADOS_CoSoTot = test_pheno_up[dataTest$data$concensus$sampleName, 'final_ADOS_CoSoTot']
dataTest$data$concensus$recentDxJ_dxCode = test_pheno_up[dataTest$data$concensus$sampleName, 'recentDxJ_dxCode']
dataTest$data$concensus$recentDxJ_ageMo = test_pheno_up[dataTest$data$concensus$sampleName, 'recentDxJ_ageMo']

cor(dataTest$data$concensus$weightedEstimate, dataTest$data$concensus$final_ADOS_CoSoTot, use="complete.obs")
ggplot(dataTest$data$concensus[dataTest$data$concensus$recentDxJ_dxCode %in% c("ASD","ASD Features"),],aes(as.numeric(final_ADOS_CoSoTot),weightedEstimate,color=recentDxJ_dxCode))+geom_point()+geom_smooth(method = "lm")+ggtitle("Eval dataset")

#TD subjects in the evaluation dataset with scores above 0.75
print("TD subjects in the evaluation dataset with scores above 0.75")
x=dataMain$data$concensus[dataMain$data$concensus$weightedEstimate>0.75 & dataMain$data$concensus$recentDxJ_dxCode=="TD",]

print("All false positives TDs have stable DX")
print("Age Mo of last DX for false positive TDs:")
print(x$recentDxJ_ageMo)

x=dataMain$data$concensus[dataMain$data$concensus$recentDxJ_dxCode=="TD",]
plot(x$age,x$weightedEstimate,xlab="Age",ylab="Score",main=paste("TD subjects\npvalue:",t.test(as.numeric(x$age)~(x$weightedEstimate>0.75))$p.value))


plot(as.numeric(x$age),x$final_ADOS_CoSoRRTot)

###is there a group of classifiers who classify the poorly classified ASD group well?

altModelMain=.myAlternativeModelExplorerFn(dataMain)
altModelLD=.myAlternativeModelExplorerFn(dataLD)
altModelTest=.myAlternativeModelExplorerFn(dataTest)
altModelLong=.myAlternativeModelExplorerFn(dataLong)

df=data.frame(class="TD",score=1- altModelMain$indxTDPoor$estimated,stringsAsFactors = F)
df=rbind(df,data.frame(class="TD",score=1- altModelTest$indxTDPoor$estimated,stringsAsFactors = F))
df=rbind(df,data.frame(class="LD",score=altModelLD$indxASDPoor$estimated,stringsAsFactors = F))
df=rbind(df,data.frame(class="ASD-eval",score=altModelMain$indxASDPoor$estimated,stringsAsFactors = F))
df=rbind(df,data.frame(class="ASD-test",score=1- altModelTest$indxASDPoor$estimated,stringsAsFactors = F))

ggplot(df,aes(df$score,color=df$class))+geom_density()+theme_bw()+xlab("Good alternative classification models\nSubjects with poor classification in the consunsus")
rm(df,altModelLD,altModelLong,altModelMain,altModelTest)

#DE analysis
.myDEanalysisFn=function(inputData){
  inputData=expTest
  model=model.matrix(~0+sampleLabel,data=inputData)
  colnames(model)=c("good","poor","TD")
  fit = lmFit(inputData,design=model)
  
  contrast1=makeContrasts(poor-TD,good-TD,levels=model)
  fit=contrasts.fit(fit,contrasts=contrast1)
  fit=eBayes(fit,robust = T)
  asdGood=topTable(fit,number=dim(fit)[1],coef="good - TD");
  asdPoor=topTable(fit,number=dim(fit)[1],coef="poor - TD");
  
  pvalDf=data.frame(class="good classification",pval=asdGood$P.Value,stringsAsFactors = F)
  pvalDf=rbind(pvalDf,data.frame(class="poor classification",pval=asdPoor$P.Value,stringsAsFactors = F))
  return(list(goodClassification=asdGood,poorClassification=asdPoor,pvalDist=pvalDf))
}

# load("~/Documents/archive/UCSD_data/myData/classification_paper_main_ageBalanced_05162019.rda")
load("/Volumes/Work/Vahid_work/classification_newcode_data/inputDataJabba_main.rda")

expMain=inputExpData[,match(dataMain$data$concensus$sampleName,colnames(inputExpData))]
expMain$sampleLabel="other"
expMain$sampleLabel[dataMain$data$concensus$recentDxJ_dxCode=="TD"]="TD"
# expMain$sampleLabel[dataMain$data$concensus$recentDxJ_dxCode=="other"]="TD"
expMain$sampleLabel[dataMain$data$concensus$recentDxJ_dxCode=="ASD"&dataMain$data$concensus$weightedEstimate>=0.75]="good"
expMain$sampleLabel[dataMain$data$concensus$recentDxJ_dxCode=="ASD"&dataMain$data$concensus$weightedEstimate<0.75]="poor"

DEmain=.myDEanalysisFn(expMain)
pdf(file=paste0(inputPath,"pval_density_main_dataset.pdf"))

ggplot(DEmain$pvalDist,aes(pval,color=class))+
  # layer(geom = "area", mapping = aes(x = )),
  #         geom_params = list(fill = "red", alpha = 0.5))+
  geom_density()+theme_bw()+theme(axis.text = element_text(color="black"),panel.grid = element_blank())+ggtitle("Evaluation dataset")
dev.off()
rm(expMain,inputExpData)

# load("~/Documents/archive/UCSD_data/myData/classification_paper_testData_05162019.rda")
load("/Volumes/Work/Vahid_work/classification_newcode_data/final_testDataset_HT12_test/out1/data.rda")
testData = data[["testInputData"]]
expTest=testData[,match(dataTest$data$concensus$sampleName,colnames(testData))]
expTest$sampleLabel="other"
expTest$sampleLabel[dataTest$data$concensus$recentDxJ_dxCode=="TD"]="TD"
expTest$sampleLabel[dataTest$data$concensus$recentDxJ_dxCode=="ASD"&dataTest$data$concensus$weightedEstimate>=0.75]="good"
expTest$sampleLabel[dataTest$data$concensus$recentDxJ_dxCode=="ASD"&dataTest$data$concensus$weightedEstimate<0.75]="poor"
expTest$sampleLabel[expTest$sampleLabel=="other"]="TD"
DEtest=.myDEanalysisFn(expTest)

pdf(file=paste0(inputPath,"pval_density_test_dataset.pdf"))
ggplot(DEtest$pvalDist,aes(pval,color=class))+
  # layer(geom = "area", mapping = aes(x = ifelse(x>-1.2 & x<1.1 , x, 0)),
  #         geom_params = list(fill = "red", alpha = 0.5))+
  geom_density()+
  theme_bw()+
  theme(axis.text = element_text(color="black"),panel.grid = element_blank())+ggtitle("Test dataset")
dev.off()
rm(expTest,testData)

#checking for prenatal events
prenatal=read.table("/Users/gazestani/Desktop/Desktop/Desktop/Desktop/prenatal_birth_history/Prenatal_birth_project_4.18.2019/prenatal_events.txt",sep="\t",header = T,stringsAsFactors = F,quote ="",comment.char = "",dec=NULL)

bloodId=c(as.character(dataMain$data$concensus$sampleName),as.character(dataTest$data$concensus$sampleName))
sampleNames=c(as.character(dataMain$data$concensus$subjectId),as.character(dataTest$data$concensus$subjectId))
scores=c(dataMain$data$concensus$weightedEstimate,dataTest$data$concensus$weightedEstimate)
DX=c(dataMain$data$concensus$real,dataTest$data$concensus$real)
df=data.frame(bloodId=bloodId,sampleNames=sampleNames,scores=scores,dx=DX,stringsAsFactors = F)
rm(sampleNames,scores,DX)

df=merge(df,prenatal,by.x="sampleNames",by.y="SubjectId")
df$category="other"
df$category[df$dx==0]="TD"
df$category[df$dx==1&df$scores>=0.75]="good"
df$category[df$dx==1&df$scores<0.75]="poor"

df$Hosp_tri=gsub("-",NA,df$Hosp_tri)
df$Hosp_med=gsub("-",NA,df$Hosp_med)
df$Surgery_tri=gsub("-",NA,df$Surgery_tri)
df$Surgery_med[which(df$Surgery_med=="C-section")]=NA
df$WtLoss_tri=gsub("-",NA,df$WtLoss_tri)
df$WtLoss_tri[!is.na(df$WtLoss_tri)]=1
df$GenAnes=gsub("-",NA,df$GenAnes)
df$GenAnes=gsub("N",NA,df$GenAnes)
df$ConfBed_med=gsub("none",NA,df$ConfBed_med)
df$ConfBed_med=gsub("none, bedrest",NA,df$ConfBed_med)
df$ConfBed_tri=gsub("-",NA,df$ConfBed_tri)
df$LocAnes=gsub("N",NA,df$LocAnes)
df$LocAnes=gsub("-",NA,df$LocAnes)

table(df$LocAnes,df$category)

concensus=rep(0,nrow(df))
concensus[!is.na(df$Hosp_tri)]=1
concensus[!is.na(df$Hosp_med)]=1
concensus[!is.na(df$Surgery_med)]=1
concensus[!is.na(df$Surgery_tri)]=1
concensus[!is.na(df$GenAnes)]=1
concensus[!is.na(df$ConfBed_med)]=1
concensus[!is.na(df$ConfBed_tri)]=1
#concensus[!is.na(df$LocAnes)]=1

concensus2=rep(0,nrow(df))
concensus2[!is.na(df$Nausea_tri)]=1
concensus2[!is.na(df$Nausea_med)]=1
concensus2[!is.na(df$MornSick_tri)]=1
concensus2[!is.na(df$MornSick_med)]=1
concensus2[!is.na(df$Swell_tri)]=1






table(xMain$Narcotics_med[xCategory!="TD"],xCategory[xCategory!="TD"],useNA='ifany')

table(concensus,df$category,useNA='ifany')
fisher.test(rbind(c(29,41),c(6,13)))
fisher.test(rbind(c(17,41),c(14,13)))

fisher.test(rbind(c(29,17),c(6,14)))


######################################
csbs=read.table("~/Desktop/CSBS.txt",sep="\t",header=T,stringsAsFactors = F,na.strings = "NULL")
csbs=csbs[!is.na(csbs$CSBS_subjectid),]
csbs$finalscore=csbs$CSBS_sub1_social_3
csbs$finalscore[is.na(csbs$finalscore)]=csbs$CSBS_sub1_social_2[is.na(csbs$finalscore)]
csbs$finalscore[is.na(csbs$finalscore)]=csbs$CSBS_sub1_social_1[is.na(csbs$finalscore)]

csbs=csbs[,c('CSBS_subjectid','finalscore')]

csbs=merge(csbs,data$concensus,by.x="CSBS_subjectid",by.y='subjectId')

csbs$col="black"
csbs$col[csbs$real==1]="red"
plot(csbs$estimated,csbs$finalscore,col=csbs$col)

plot(csbs$estimated[csbs$real==1],csbs$finalscore[csbs$real==1])
plot(csbs$estimated[csbs$real==0],csbs$finalscore[csbs$real==0])
cor(csbs$estimated[csbs$real==1],csbs$finalscore[csbs$real==1])



##############################################
library(reshape2)
#save(pdata,file="~/Desktop/myData/classificationMainPdata.rda")
#save(data4,file="~/Desktop/myData/data4.rda")
rm(list=ls())

load("~/Desktop/myData/classificationMainPdata.rda")
load("~/Desktop/myData/data4.rda")
load("~/Desktop/myData/LWdata.rda")
data4=merge(data4,pdata,by="sampleName")
data4=merge(data4,LWdata,by.x='subjectId',by.y='subjectid')

boxplot(data4$estimated~data4$final_ADOS_CoSoRRTot>13)

table(data4$estimated[data4$diagnosis_binary=="ASD"]>1600,data4$final_ADOS_CoSoRRTot[data4$diagnosis_binary=="ASD"]>15)

cor(data4$estimated[data4$diagnosis_binary=="ASD"],data4$final_ADOS_CoSoRRTot[data4$diagnosis_binary=="ASD"])

data5=data4[data4$diagnosis_binary=="ASD",]


data5=x
plot(data5$final_ADOS_CoSoTot,data5$estimated)
cor(data5$estimated,data5$final_ADOS_CoSoRRTot)
cor(data5$estimated,data5$final_ADOS_CoSoTot)
cor(data5$estimated,data5$final_mullen_ELC,use="complete")
cor(data5$estimated,data5$final_mullen_ELT,use="complete")
cor(data5$estimated,data5$final_mullen_ELC,use="complete")
cor(data5$estimated,data5$final_ADOS_RRTot,use="complete")
cor(data5$estimated,data5$final_vine_AdapBehav_DomStd,use="complete")

cor(data5$estimated,data5$Neutrophil,use="complete")
cor(data5$estimated,data5$Tcell,use="complete")
cor(data5$estimated,data5$Monocyte,use="complete")
cor(data5$estimated,data5$Bcell,use="complete")
cor(data5$estimated,data5$NKcell,use="complete")
cor(data5$estimated,data5$PlasmaCell,use="complete")

summary(lm(estimated~final_vine_AdapBehav_DomStd,data=data5))

summary(lm(estimated~final_ADOS_CoSoTot,data=data5))


plot(as.factor(data4$final_ADOS_CoSoTot),as.factor(data4$estimated>1600))

```

